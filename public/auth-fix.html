<!DOCTYPE html>
<html>
<head>
  <title>Voice Memory - Auth Fix</title>
</head>
<body>
  <h1>Fixing Authentication...</h1>
  <div id="status"></div>
  
  <script>
    const status = document.getElementById('status');
    
    // Get tokens from URL
    const hash = window.location.hash;
    const params = new URLSearchParams(hash.substring(1));
    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');
    const expiresAt = params.get('expires_at');
    
    if (accessToken && refreshToken) {
      status.innerHTML = 'Found tokens, setting session...';
      
      // Parse JWT
      const base64Url = accessToken.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const payload = JSON.parse(window.atob(base64));
      
      // Create session
      const session = {
        access_token: accessToken,
        refresh_token: refreshToken,
        expires_in: 3600,
        expires_at: parseInt(expiresAt) || (Math.floor(Date.now() / 1000) + 3600),
        token_type: 'bearer',
        user: {
          id: payload.sub,
          email: payload.email,
          user_metadata: payload.user_metadata || {},
          app_metadata: payload.app_metadata || {},
          aud: payload.aud,
          role: payload.role
        }
      };
      
      // Store in localStorage
      const storageKey = 'sb-vbjszugsvqrxosbtfqw-auth-token';
      const storageValue = {
        currentSession: session,
        expiresAt: session.expires_at
      };
      
      localStorage.setItem(storageKey, JSON.stringify(storageValue));
      status.innerHTML = '✅ Session stored! Redirecting...';
      
      // Redirect to home
      setTimeout(() => {
        window.location.href = '/';
      }, 1000);
    } else {
      status.innerHTML = '❌ No tokens found. Please use a valid magic link.';
    }
  </script>
</body>
</html>